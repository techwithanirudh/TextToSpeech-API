<form>
	<input type="text" id="text" name="text" value="Hello World">
	<button onclick="event.preventDefault(); talker.speak(this.parentElement.querySelector(`input#text[name='text']`).value)">Speak</button>
</form>
<script defer>
	// async function speak(text, language='en') {
	// 	const response = await fetch('/api/v1/speak/', {
	// 	    method: "POST",
	// 	    headers: {
	// 	        'Content-Type': 'application/json'
	// 	    },
	// 	    body: JSON.stringify({
	// 	        text: text,
	// 	        language: language
	// 	    })
	// 	});
		
	// 	const audioBlob = await response.blob();
	// 	const audioUrl = window.URL.createObjectURL(audioBlob);
		
	// 	const audioEl = document.createElement('audio');
	// 	audioEl.src = audioUrl;
	// 	audioEl.play();
		
	// 	return audioEl
	// }
	
	class Speech {
		constructor(language) {
	    	this.language = 'en';
			this.languages = {'en': 'English'};
			this.getLanguages()
			this.pending = false; 
			this.speaking = false; 
			this.paused = false; 
			this.audio = null; 
		}

		async getLanguages() {
			var languages = await fetch('/api/v1/languages/') 
			languages = await languages.json()

			this.languages = languages
			
			return languages
		}

		async getName(language) {
			language = this.languages[language]
			const name = `Google Speech Online ${language}`

			return name
		}
		
		getVoices() {
			var languages = Object.keys(this.languages)

			var voices = []

			languages.forEach(language => {
				var _default = false
				var lang = language
				var localService = false
				var name = this.getName(language)
				var voiceURI = this.getName(language)
				
				if (language === 'en') var _default = true

				var voice = { default: _default, lang: language, localService: localService, name: name, voiceURI: voiceURI }
				voices.push(voice)
			})
			
			return voices
		}
		
		
		async speak(text) {
			const self = this;
  	  		const response = await fetch('/api/v1/speak/', {
			    method: "POST",
			    headers: {
			        'Content-Type': 'application/json'
			    },
			    body: JSON.stringify({
			        text: text,
			        language: this.language,
			    })
			});
		
			const audioBlob = await response.blob();
			const audioUrl = window.URL.createObjectURL(audioBlob);

			const audio = document.createElement('audio');
			this.audio = audio;
	
			audio.src = audioUrl;
			audio.play();

			this.speaking = true; 

			audio.onended = function() { self.speaking = false }
		
			return this.audio;
		}


		pause() {
			this.audio.pause();
		}

		resume() {
			this.audio.play();
		}
		
		cancel() {
			this.audio.pause();
            this.audio.remove();
		}
	}

	window.talker = new Speech()
</script>